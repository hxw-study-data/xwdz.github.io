<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>为什么不能再子线程修改UI | 酸菜</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">为什么不能再子线程修改UI</h1><a id="logo" href="/.">酸菜</a><p class="description">情绪疯子</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">为什么不能再子线程修改UI</h1><div class="post-meta">Jun 13, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h4 id="如果在子线程中修改UI报错如下"><a href="#如果在子线程中修改UI报错如下" class="headerlink" title="如果在子线程中修改UI报错如下:"></a>如果在子线程中修改UI报错如下:</h4><p><img src="http://upload-images.jianshu.io/upload_images/2651056-9eadcc13ddd9201d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="报错"></p>
<p>如果问题搞清楚了这三大原则基本上就ok了；</p>
<ul>
<li>why</li>
<li>what  </li>
<li>how</li>
</ul>
<h2 id="Why？"><a href="#Why？" class="headerlink" title="Why？"></a>Why？</h2><p>  为什么会报错，报错的方法是checkThread，requestLayout 方法都在ViewRootimpl 类里面,<br>  也就是说一旦ViewRootImpl 这个类被实例化,则就会调用requestLaoyout 方法来检查,requestLayout    方法如下:<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</div><div class="line">            checkThread();</div><div class="line">            mLayoutRequested = <span class="keyword">true</span>;</div><div class="line">            scheduleTraversals();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//报错如下</span></div><div class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</div><div class="line">                    <span class="string">"Only the original thread that created a view hierarchy can touch its views."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>报错的原因是因为咱们没有在主线程里面去修改UI,chechThread 方法会检查当前线程是不是主线程</p>
</blockquote>
<p>##How </p>
<blockquote>
<p>正确修改方法如下：</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler()&#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">          <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">        <span class="comment">//当子线程获取到数据之后使用Handler 来修改UI</span></div><div class="line">        <span class="comment">// 当然如果这样写会存在内存泄露  这里不做讨论</span></div><div class="line">        <span class="keyword">if</span>(msg.waht == <span class="number">0x123</span>)&#123;</div><div class="line">              textView.setText(<span class="string">"主线程修改UI"</span>);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">      &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">      <span class="keyword">this</span>.supportRequestWindowFeature(Window.FEATURE_ACTION_BAR);</div><div class="line">      setContentView(R.layout.aty_xxx);</div><div class="line"></div><div class="line">     <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">//获取数据</span></div><div class="line">               <span class="comment">//成功之后使用handler 发送what</span></div><div class="line">              Message msg = Message.obtain();</div><div class="line">              msg.what = <span class="number">0x123</span>;</div><div class="line">              msg.obj = datas;</div><div class="line">              hanlder.sendMessage(msg)</div><div class="line">          &#125;</div><div class="line">      &#125;).start();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p> 以上就是在主线程修改UI的标准写法。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>请观察以下代码<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        <span class="keyword">this</span>.supportRequestWindowFeature(Window.FEATURE_ACTION_BAR);</div><div class="line">        setContentView(R.layout.aty_xxx);</div><div class="line"></div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                textView.setText(<span class="string">"我在onCreate方法 一开始的时候就修改UI你拿我怎的?"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上代码会不会执行成功呢？<br>如果你是从文章的开始看到这里来的话也许您会说肯定不能运行啊，不能再子线程里面修改UI啊；<br>很遗憾，程序会正常运行，（截图我就不上了，有兴趣探究的同学可以试试）而模拟器上也会显示textView 几个大字；那到底这是为什么呢？</p>
<p> 这里我们回到之前的为什么会报错，咱们进入源码看一看：、<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</div><div class="line">            checkThread();</div><div class="line">            mLayoutRequested = <span class="keyword">true</span>;</div><div class="line">            scheduleTraversals();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//报错如下</span></div><div class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</div><div class="line">                    <span class="string">"Only the original thread that created a view hierarchy can touch its views."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>前面说到了如果实例化了ViewRootImpl 这个类则会检查当前线程是不是主线程，那么直接杀到在哪里实例化ViewRootImpl 这个类的地方不就水落石出了嘛，别急,咱们一步一步来:<br>可以看到requestLayout 调用了checkThread ，和scheduleTraversals（） 方法，前者呢 是抛出错误的地方那后者呢？<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mTraversalScheduled) &#123;</div><div class="line">            mTraversalScheduled = <span class="keyword">true</span>;</div><div class="line">            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</div><div class="line">            mChoreographer.postCallback(</div><div class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</div><div class="line">         <span class="comment">// 省略</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里postCallback 方法 第一个为一个常数，第三个是null，第二个则是一跟线程，代码如下；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            doTraversal();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mTraversalScheduled) &#123;</div><div class="line">            mTraversalScheduled = <span class="keyword">false</span>;</div><div class="line">            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mProfile) &#123;</div><div class="line">                Debug.startMethodTracing(<span class="string">"ViewAncestor"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            performTraversals();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mProfile) &#123;</div><div class="line">                Debug.stopMethodTracing();</div><div class="line">                mProfile = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p> performTraversals() 这个方法则是View进行绘制的开始； 每一次访问UI，即UI则会重绘；</p>
<p>回过头来我们再来找找在哪里进行实例化 ViewRootimpl  的；<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">final</span> <span class="keyword">void</span> handleResumeActivity(IBinder token,</div><div class="line">            <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume) &#123;</div><div class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">        <span class="comment">// we are back active so skip it.</span></div><div class="line">        unscheduleGcIdler();</div><div class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></div><div class="line">       <span class="comment">// 执行resume activity </span></div><div class="line">        ActivityClientRecord r = performResumeActivity(token, clearHide);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> Activity a = r.activity;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</div><div class="line">                TAG, <span class="string">"Resume "</span> + r + <span class="string">" started activity: "</span> +</div><div class="line">                a.mStartedActivity + <span class="string">", hideForNow: "</span> + r.hideForNow</div><div class="line">                + <span class="string">", finished: "</span> + a.mFinished);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 可以看到上面执行了resumeActivity 方法 ； 方法如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> ActivityClientRecord performResumeActivity(IBinder token,</div><div class="line">            <span class="keyword">boolean</span> clearHide) &#123;</div><div class="line">        ActivityClientRecord r = mActivities.get(token);</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing resume of "</span> + r</div><div class="line">                + <span class="string">" finished="</span> + r.activity.mFinished);</div><div class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; !r.activity.mFinished) &#123;</div><div class="line">            <span class="keyword">if</span> (clearHide) &#123;</div><div class="line">                r.hideForNow = <span class="keyword">false</span>;</div><div class="line">                r.activity.mStartedActivity = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">               <span class="comment">// 省略</span></div><div class="line">                r.activity.performResume();</div><div class="line">              <span class="comment">//省略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里可以看到回调了activity.performResume() 方法 方法如下:</p>
<h4 id="Activity-gt-performResume"><a href="#Activity-gt-performResume" class="headerlink" title="Activity ===&gt;performResume()"></a>Activity ===&gt;performResume()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">performResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        performRestart();</div><div class="line"></div><div class="line">        mFragments.execPendingActions();</div><div class="line"></div><div class="line">        mLastNonConfigurationInstances = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        mCalled = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// mResumed is set by the instrumentation</span></div><div class="line">        mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!mCalled) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                <span class="string">"Activity "</span> + mComponent.toShortString() +</div><div class="line">                <span class="string">" did not call through to super.onResume()"</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mInstrumentation 是用来辅助Activity完成启动Activity的过程</p>
<h4 id="Instrumentation-gt-callActivityOnResume"><a href="#Instrumentation-gt-callActivityOnResume" class="headerlink" title="Instrumentation===&gt;callActivityOnResume()"></a>Instrumentation===&gt;callActivityOnResume()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> callActivityOnResume(Activity activity) &#123;</div><div class="line">     activity.mResumed = <span class="keyword">true</span>;</div><div class="line">     activity.onResume();</div><div class="line">     </div><div class="line">     <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">             <span class="keyword">final</span> <span class="built_in">int</span> N = mActivityMonitors.<span class="built_in">size</span>();</div><div class="line">             <span class="keyword">for</span> (<span class="built_in">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                 <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.<span class="built_in">get</span>(i);</div><div class="line">                 am.<span class="built_in">match</span>(activity, activity, activity.getIntent());</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>可是看到真正执行onResume在这里 也就是说执行到这里 activity 的生命周期经历如下<br>onCreate  —– onStart  ——onResume;</p>
<p>而performResumeActivity 里面执行完回调activity.onResume() 方法 有如下代码:<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">r.activity.mVisibleFromServer = true<span class="comment">;</span></div><div class="line"> mNumVisibleActivities++<span class="comment">;</span></div><div class="line"> if (r.activity.mVisibleFromClient) &#123;</div><div class="line">     r.activity.makeVisible()<span class="comment">;</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>进入makeVisible 如下:</p>
<h4 id="Activity-gt-callActivityOnResume"><a href="#Activity-gt-callActivityOnResume" class="headerlink" title="Activity===&gt;callActivityOnResume()"></a>Activity===&gt;callActivityOnResume()</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">void makeVisible() &#123;</div><div class="line">      if (!mWindowAdded) &#123;</div><div class="line">          ViewManager wm = getWindowManager()<span class="comment">;</span></div><div class="line">          wm.<span class="keyword">addView(mDecor, </span>getWindow().getAttributes())<span class="comment">;</span></div><div class="line">          mWindowAdded = true<span class="comment">;</span></div><div class="line">      &#125;</div><div class="line">      mDecor.setVisibility(View.VISIBLE)<span class="comment">;</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ViewManager 是一个抽象类，而mDecor 是一个View ，我们找到ViewManager 实现类如下:</p>
<h4 id="WindowManagerGlobal-gt-addView"><a href="#WindowManagerGlobal-gt-addView" class="headerlink" title="WindowManagerGlobal===&gt;addView()"></a>WindowManagerGlobal===&gt;addView()</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span>(<span class="params">View view, ViewGroup.LayoutParams <span class="keyword">params</span>,</span></span></div><div class="line"><span class="function"><span class="params">           Display display, Window parentWindow</span>) </span>&#123;</div><div class="line">       <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (display == <span class="literal">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"display must not be null"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!(<span class="keyword">params</span> instanceof WindowManager.LayoutParams)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Params must be WindowManager.LayoutParams"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">         <span class="comment">//省略</span></div><div class="line"></div><div class="line">       ViewRootImpl root;</div><div class="line">       View panelParentView = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">//省略</span></div><div class="line"></div><div class="line">           root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</div><div class="line"></div><div class="line">           view.setLayoutParams(wparams);</div><div class="line"></div><div class="line">           mViews.<span class="keyword">add</span>(view);</div><div class="line">           mRoots.<span class="keyword">add</span>(root);</div><div class="line">           mParams.<span class="keyword">add</span>(wparams);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//省略</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>进入到addView 方法内部终于找到了实例化ViewRootImpl 的地方;</p>
<p>这也就是解释了为什么在oncreate 生命周期刚开始的时候在子线程修改UI会报错呢，因此此时的ViewRootImpl 还没有被实例化；</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ActivityClientRecord r</span> = performResumeActivity(token, clearHide);</div></pre></td></tr></table></figure>
<p>要知道ViewRootImpl 实例化是在执行完handleResumeActivity 方法里面以上代码之后哦，而performResumeActivity 是回调activity.onResume的，他们的流程是这样的</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2651056-4b260d2b4cc40b4b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="QQ图片20170109113641.png"></p>
<p>可是ViewRootImpl 实例化最后的过程是在activity -&gt; makeVisible 方法里面在里面调用了<br>在WindowManagerGlobal （ViewManager 的实现类）—&gt;addView 真正实行了ViewRootImpl 的实例化</p>
<p>有时候看源码真的很枯燥，但是某一个把自己看过的源码给串起来的感觉真的特别好（比如笔者之后有了解了activity的启动过程）;</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章:"></a>参考文章:</h3><p><a href="http://blog.csdn.net/xyh269/article/details/52728861" target="_blank" rel="external">http://blog.csdn.net/xyh269/article/details/52728861</a><br><a href="http://blog.csdn.net/singwhatiwanna/article/details/18154335" target="_blank" rel="external">http://blog.csdn.net/singwhatiwanna/article/details/18154335</a></p>
</div><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a href="/2017/10/03/git命令记录/" class="pre">Git命令记录</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'xwdz',
  repo: 'xwdz.github.io',
  oauth: {
    client_id: 'c62ab72e41cea1fc64ce',
    client_secret: '2b4319c22eabf970e7f8301c302934e6a641dbf4',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android-hook/">android-hook</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/music/">music</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日常侃侃/">日常侃侃</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/git/" style="font-size: 15px;">git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/13/她说每个人心中都有一首歌/">她说每个人心中都有一首歌</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/07/只道寻常/">只道寻常</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/20/仪式感/">仪式感</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/Android-App检测升级库/">Android-App检测升级库</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/09/Android Hook基础-一行代码实现开屏广告/">Android Hook基础-一行代码实现开屏广告</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/最后的唐寅/">最后的唐寅</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/03/假期之后/">假期之后</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/01/Java设计模式-观察者模式/">Java设计模式 观察者模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/28/Android Hook基础-动态代理/">Android Hook基础-动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/27/Android Hook基础-反射/">Android Hook基础-反射</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://msdx.github.io./" title="貌似掉线" target="_blank">貌似掉线</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">酸菜.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>